<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TransportGo Admin</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0A1628;--bg2:#0F1D32;--bg3:#152238;--border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.1);--text:#fff;--text2:rgba(255,255,255,0.7);--text3:rgba(255,255,255,0.45);--primary:#1B6EF3;--primary-dim:rgba(27,110,243,0.12);--teal:#00C9A7;--teal-dim:rgba(0,201,167,0.12);--green:#22c55e;--green-dim:rgba(34,197,94,0.15);--yellow:#f59e0b;--yellow-dim:rgba(245,158,11,0.15);--red:#ef4444;--red-dim:rgba(239,68,68,0.15);--purple:#8b5cf6;--purple-dim:rgba(139,92,246,0.15);--blue:#3b82f6;--blue-dim:rgba(59,130,246,0.15);--sidebar-w:240px;--topbar-h:60px;--radius:12px;--radius-sm:8px;--radius-xs:6px;--shadow:0 4px 24px rgba(0,0,0,0.25)}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Helvetica,Arial,sans-serif;line-height:1.5;-webkit-font-smoothing:antialiased}
input,button,select,textarea{font-family:inherit;outline:none}
a{text-decoration:none;color:inherit}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.2)}

.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at 50% 0%,rgba(27,110,243,0.08) 0%,transparent 60%)}
.login-card{background:var(--bg2);border:1px solid var(--border2);border-radius:20px;padding:48px 40px;width:100%;max-width:420px;animation:scaleIn .4s cubic-bezier(.16,1,.3,1) forwards;box-shadow:var(--shadow)}
@keyframes scaleIn{from{opacity:0;transform:scale(.94) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.login-logo{width:48px;height:48px;background:linear-gradient(135deg,var(--primary),var(--teal));border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:22px;font-weight:800;color:#fff}
.login-card h1{font-size:22px;font-weight:700;text-align:center;margin-bottom:4px}
.login-card .subtitle{color:var(--text3);font-size:14px;text-align:center;margin-bottom:32px}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.form-group input{width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid var(--border2);border-radius:var(--radius-sm);color:#fff;font-size:15px;transition:border-color .2s,box-shadow .2s}
.form-group input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-dim)}
.btn-primary{width:100%;padding:13px;background:linear-gradient(135deg,var(--primary),#0052cc);color:#fff;border:none;border-radius:var(--radius-sm);font-size:15px;font-weight:600;cursor:pointer;transition:transform .15s,box-shadow .15s}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(27,110,243,0.35)}
.btn-primary:active{transform:translateY(0)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.error-msg{background:var(--red-dim);color:#f87171;padding:10px 14px;border-radius:var(--radius-xs);font-size:13px;margin-bottom:16px;display:none}

.app-wrap{display:none;height:100vh;overflow:hidden}
.sidebar{position:fixed;left:0;top:0;bottom:0;width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;transition:width .25s ease}
.sidebar-header{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);height:var(--topbar-h);flex-shrink:0}
.sidebar-header .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--primary),var(--teal));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;flex-shrink:0}
.sidebar-header .logo-text{font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden}
.sidebar-nav{flex:1;padding:12px 0;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:14px;padding:11px 20px;font-size:14px;font-weight:500;color:var(--text3);cursor:pointer;transition:all .2s;border-left:3px solid transparent;margin:1px 0}
.nav-item:hover{color:var(--text2);background:rgba(255,255,255,0.03)}
.nav-item.active{color:var(--primary);background:var(--primary-dim);border-left-color:var(--primary)}
.nav-item svg{width:20px;height:20px;flex-shrink:0}
.nav-item .nav-label{white-space:nowrap;overflow:hidden}
.sidebar-footer{padding:16px 20px;border-top:1px solid var(--border);flex-shrink:0}
.back-link{display:flex;align-items:center;gap:10px;color:var(--text3);font-size:13px;font-weight:500;cursor:pointer;transition:color .2s;padding:6px 0}
.back-link:hover{color:var(--teal)}
.back-link svg{width:18px;height:18px;flex-shrink:0}

.main{margin-left:var(--sidebar-w);height:100vh;display:flex;flex-direction:column;transition:margin-left .25s ease}
.topbar{height:var(--topbar-h);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 28px;background:rgba(10,22,40,.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);flex-shrink:0;position:sticky;top:0;z-index:50}
.topbar-title{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
.topbar-right{display:flex;align-items:center;gap:12px}
.topbar-time{font-size:13px;color:var(--text3);font-variant-numeric:tabular-nums}
.logout-btn{background:var(--red-dim);color:#f87171;border:none;padding:8px 16px;border-radius:var(--radius-xs);font-size:13px;font-weight:600;cursor:pointer;transition:background .2s}
.logout-btn:hover{background:rgba(239,68,68,0.25)}

.content{flex:1;overflow-y:auto;padding:28px;scroll-behavior:smooth}
.tab-content{display:none;animation:fadeTab .35s ease}
.tab-content.active{display:block}
@keyframes fadeTab{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:22px;position:relative;overflow:hidden;transition:border-color .2s,transform .2s}
.stat-card:hover{border-color:var(--border2);transform:translateY(-2px)}
.stat-card .stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;font-size:18px}
.stat-card .stat-label{font-size:13px;color:var(--text3);margin-bottom:6px;font-weight:500}
.stat-card .stat-value{font-size:26px;font-weight:700;font-variant-numeric:tabular-nums}
.stat-card::after{content:'';position:absolute;top:0;right:0;width:80px;height:80px;border-radius:50%;filter:blur(40px);opacity:.15}
.stat-card.c-blue .stat-icon{background:var(--primary-dim);color:var(--primary)}
.stat-card.c-blue .stat-value{color:var(--primary)}
.stat-card.c-blue::after{background:var(--primary)}
.stat-card.c-teal .stat-icon{background:var(--teal-dim);color:var(--teal)}
.stat-card.c-teal .stat-value{color:var(--teal)}
.stat-card.c-teal::after{background:var(--teal)}
.stat-card.c-purple .stat-icon{background:var(--purple-dim);color:var(--purple)}
.stat-card.c-purple .stat-value{color:var(--purple)}
.stat-card.c-purple::after{background:var(--purple)}
.stat-card.c-green .stat-icon{background:var(--green-dim);color:var(--green)}
.stat-card.c-green .stat-value{color:var(--green)}
.stat-card.c-green::after{background:var(--green)}

.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
.dash-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:22px}
.dash-card-title{font-size:15px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.chart-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:22px}
.chart-wrap h3{font-size:15px;font-weight:600;margin-bottom:16px}
.chart-container{position:relative;height:260px}

.section-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:12px;flex-wrap:wrap}
.section-bar h3{font-size:18px;font-weight:600;white-space:nowrap}
.search-input{padding:9px 14px 9px 36px;background:rgba(255,255,255,0.05);border:1px solid var(--border2);border-radius:var(--radius-sm);color:#fff;font-size:14px;width:280px;transition:border-color .2s,box-shadow .2s;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='rgba(255,255,255,0.35)' stroke-width='2' stroke-linecap='round'%3E%3Ccircle cx='7' cy='7' r='5'/%3E%3Cline x1='11' y1='11' x2='15' y2='15'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:12px center}
.search-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-dim)}
.search-input::placeholder{color:var(--text3)}
.filter-group{display:flex;gap:6px;flex-wrap:wrap}
.filter-btn{padding:7px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:var(--radius-xs);color:var(--text3);font-size:13px;font-weight:500;cursor:pointer;transition:all .2s}
.filter-btn:hover{color:var(--text2);border-color:var(--border2)}
.filter-btn.active{background:var(--primary-dim);color:var(--primary);border-color:rgba(27,110,243,0.3)}

.data-table{width:100%;border-collapse:separate;border-spacing:0}
.data-table thead{position:sticky;top:0;z-index:5}
.data-table th{text-align:left;padding:12px 14px;font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;background:var(--bg3);border-bottom:1px solid var(--border)}
.data-table th:first-child{border-radius:var(--radius-sm) 0 0 0}
.data-table th:last-child{border-radius:0 var(--radius-sm) 0 0}
.data-table td{padding:12px 14px;font-size:13px;border-bottom:1px solid var(--border);transition:background .15s}
.data-table tbody tr{transition:all .2s}
.data-table tbody tr:hover{background:rgba(27,110,243,0.04)}
.data-table tbody tr:hover td{border-bottom-color:rgba(27,110,243,0.1)}
.data-table tbody tr.clickable{cursor:pointer}

.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;gap:5px}
.badge-green{background:var(--green-dim);color:#4ade80}
.badge-yellow{background:var(--yellow-dim);color:#fbbf24}
.badge-red{background:var(--red-dim);color:#f87171}
.badge-blue{background:var(--blue-dim);color:#60a5fa}
.badge-purple{background:var(--purple-dim);color:#a78bfa}
.badge-gray{background:rgba(255,255,255,0.06);color:var(--text3)}
.badge-teal{background:var(--teal-dim);color:var(--teal)}

.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.status-dot.online{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-dot.offline{background:rgba(255,255,255,0.2)}

.action-btn{padding:6px 12px;border-radius:var(--radius-xs);font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all .15s;white-space:nowrap}
.action-btn:hover{transform:translateY(-1px)}
.action-btn.approve{background:var(--green-dim);color:#4ade80}
.action-btn.approve:hover{background:rgba(34,197,94,0.25)}
.action-btn.delete{background:var(--red-dim);color:#f87171}
.action-btn.delete:hover{background:rgba(239,68,68,0.25)}
.action-btn.save{background:var(--primary-dim);color:#60a5fa}
.action-btn.save:hover{background:rgba(27,110,243,0.25)}
.action-btn.refresh{background:rgba(255,255,255,0.06);color:var(--text2)}
.action-btn.refresh:hover{background:rgba(255,255,255,0.1)}

.vehicles-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.vehicle-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:24px;transition:border-color .2s,transform .2s}
.vehicle-card:hover{border-color:var(--border2);transform:translateY(-2px)}
.vehicle-card .v-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.vehicle-card .v-header h3{font-size:17px;font-weight:600}
.vehicle-card .v-meta{font-size:12px;color:var(--text3);margin-bottom:2px}
.vehicle-card .v-capacity{font-size:12px;color:var(--text3);margin-bottom:16px;display:flex;align-items:center;gap:6px}
.vehicle-card .v-field{margin-bottom:14px}
.vehicle-card .v-field label{display:block;font-size:11px;font-weight:600;color:var(--text3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.vehicle-card .v-field input{width:100%;padding:9px 12px;background:rgba(255,255,255,0.05);border:1px solid var(--border2);border-radius:var(--radius-xs);color:#fff;font-size:14px;transition:border-color .2s}
.vehicle-card .v-field input:focus{border-color:var(--primary)}
.toggle{position:relative;width:44px;height:24px;cursor:pointer;flex-shrink:0}
.toggle input{display:none}
.toggle .slider{position:absolute;inset:0;background:rgba(255,255,255,0.12);border-radius:12px;transition:background .25s}
.toggle .slider::before{content:'';position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .25s}
.toggle input:checked+.slider{background:var(--teal)}
.toggle input:checked+.slider::before{transform:translateX(20px)}

.drivers-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.driver-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;display:flex;align-items:center;gap:16px;transition:border-color .2s}
.driver-card:hover{border-color:var(--border2)}
.driver-avatar{width:44px;height:44px;border-radius:12px;background:var(--primary-dim);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--primary);flex-shrink:0}
.driver-card-info{flex:1;min-width:0}
.driver-card-info h4{font-size:14px;font-weight:600;margin-bottom:2px}
.driver-card-info p{font-size:12px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.driver-card-status{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text3)}

.settings-section{max-width:600px}
.settings-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:28px}
.settings-card h3{font-size:16px;font-weight:600;margin-bottom:4px}
.settings-card p{font-size:13px;color:var(--text3);margin-bottom:20px}
.settings-item{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-top:1px solid var(--border)}
.settings-item .si-label{font-size:13px;color:var(--text2)}
.settings-item .si-value{font-size:13px;font-weight:600}

.loading{display:flex;align-items:center;justify-content:center;gap:10px;padding:48px;color:var(--text3);font-size:14px}
.spinner{width:20px;height:20px;border:2px solid var(--border2);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-state .empty-icon{font-size:40px;margin-bottom:12px;opacity:.4}
.empty-state p{font-size:14px}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:24px;animation:fadeIn .2s ease}
.modal-overlay.show{display:flex}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:640px;max-height:85vh;overflow-y:auto;animation:modalIn .3s cubic-bezier(.16,1,.3,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg2);z-index:1;border-radius:16px 16px 0 0}
.modal-header h3{font-size:16px;font-weight:600}
.modal-close{width:32px;height:32px;border-radius:8px;border:none;background:rgba(255,255,255,0.06);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:background .15s}
.modal-close:hover{background:rgba(255,255,255,0.12)}
.modal-body{padding:24px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.detail-item{padding:12px;background:rgba(255,255,255,0.03);border-radius:var(--radius-sm)}
.detail-item .di-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.detail-item .di-value{font-size:14px;font-weight:500}
.detail-item.full{grid-column:1/-1}

.toast-container{position:fixed;bottom:24px;right:24px;z-index:300;display:flex;flex-direction:column;gap:8px}
.toast{padding:14px 20px;border-radius:var(--radius-sm);font-size:14px;font-weight:500;display:flex;align-items:center;gap:10px;min-width:280px;box-shadow:var(--shadow);animation:toastIn .4s cubic-bezier(.16,1,.3,1) forwards}
.toast.removing{animation:toastOut .3s ease forwards}
@keyframes toastIn{from{opacity:0;transform:translateX(80px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(80px)}}
.toast.success{background:linear-gradient(135deg,rgba(34,197,94,.95),rgba(22,163,74,.95));color:#fff}
.toast.error{background:linear-gradient(135deg,rgba(239,68,68,.95),rgba(220,38,38,.95));color:#fff}

.mini-table{width:100%;border-collapse:collapse}
.mini-table th{text-align:left;padding:8px 10px;font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.mini-table td{padding:8px 10px;font-size:13px;border-bottom:1px solid var(--border)}
.quick-actions{display:flex;flex-direction:column;gap:10px}
.qa-btn{padding:12px 16px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;text-align:left;display:flex;align-items:center;gap:10px}
.qa-btn:hover{background:rgba(255,255,255,0.06);border-color:var(--border2);transform:translateX(4px)}
.qa-btn svg{width:18px;height:18px;flex-shrink:0}

@media(max-width:1100px){
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .vehicles-grid{grid-template-columns:repeat(2,1fr)}
  .dash-grid{grid-template-columns:1fr}
  .detail-grid{grid-template-columns:1fr}
}
@media(max-width:768px){
  .sidebar{width:64px}
  .sidebar .nav-label,.sidebar .logo-text{display:none}
  .sidebar-header{justify-content:center;padding:20px 10px}
  .sidebar-footer{padding:12px;text-align:center}
  .back-link .nav-label{display:none}
  .nav-item{justify-content:center;padding:12px;border-left:none}
  .main{margin-left:64px}
  .stats-grid{grid-template-columns:1fr 1fr}
  .vehicles-grid{grid-template-columns:1fr}
  .search-input{width:100%}
  .section-bar{flex-direction:column;align-items:stretch}
  .content{padding:16px}
}
</style>
</head>
<body>

<div id="loginPage" class="login-wrap">
  <div class="login-card">
    <div class="login-logo">TG</div>
    <h1>Admin Login</h1>
    <p class="subtitle">TransportGo Management Console</p>
    <div id="loginError" class="error-msg"></div>
    <div class="form-group">
      <label>Phone Number</label>
      <input type="text" id="loginPhone" value="9999999999" placeholder="Enter phone number">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" value="admin123" placeholder="Enter password">
    </div>
    <button class="btn-primary" id="loginBtn" onclick="doLogin()">Sign In</button>
  </div>
</div>

<div id="appWrap" class="app-wrap">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-icon">TG</div>
      <span class="logo-text">TransportGo</span>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        <span class="nav-label">Dashboard</span>
      </div>
      <div class="nav-item" data-tab="users" onclick="switchTab('users')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        <span class="nav-label">Users</span>
      </div>
      <div class="nav-item" data-tab="bookings" onclick="switchTab('bookings')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span class="nav-label">Bookings</span>
      </div>
      <div class="nav-item" data-tab="vehicles" onclick="switchTab('vehicles')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16 16,8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
        <span class="nav-label">Vehicles</span>
      </div>
      <div class="nav-item" data-tab="drivers" onclick="switchTab('drivers')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/></svg>
        <span class="nav-label">Live Drivers</span>
      </div>
      <div class="nav-item" data-tab="settings" onclick="switchTab('settings')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        <span class="nav-label">Settings</span>
      </div>
    </nav>
    <div class="sidebar-footer">
      <a href="/" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg>
        <span class="nav-label">Back to App</span>
      </a>
    </div>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-title" id="topbarTitle">Dashboard</div>
      <div class="topbar-right">
        <span class="topbar-time" id="topbarTime"></span>
        <button class="logout-btn" onclick="doLogout()">Logout</button>
      </div>
    </header>

    <div class="content">
      <!-- Dashboard -->
      <div class="tab-content active" id="tab-dashboard">
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card c-blue">
            <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/></svg></div>
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="statUsers">-</div>
          </div>
          <div class="stat-card c-teal">
            <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/></svg></div>
            <div class="stat-label">Total Bookings</div>
            <div class="stat-value" id="statBookings">-</div>
          </div>
          <div class="stat-card c-purple">
            <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg></div>
            <div class="stat-label">Active Bookings</div>
            <div class="stat-value" id="statActive">-</div>
          </div>
          <div class="stat-card c-green">
            <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></div>
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value" id="statRevenue">-</div>
          </div>
        </div>

        <div class="dash-grid">
          <div class="dash-card">
            <div class="dash-card-title">Recent Bookings <span class="badge badge-blue" id="recentCount">0</span></div>
            <div id="recentBookingsTable"></div>
          </div>
          <div class="dash-card">
            <div class="dash-card-title">Quick Actions</div>
            <div class="quick-actions">
              <button class="qa-btn" onclick="approveAllPending()">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
                Approve All Pending Drivers
              </button>
              <button class="qa-btn" onclick="loadDashboard()">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><polyline points="23,4 23,10 17,10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
                Refresh Dashboard Data
              </button>
              <button class="qa-btn" onclick="switchTab('bookings')">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>
                View All Bookings
              </button>
              <button class="qa-btn" onclick="switchTab('drivers')">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                View Live Drivers
              </button>
            </div>
          </div>
        </div>

        <div class="chart-wrap">
          <h3>Booking Distribution by Status</h3>
          <div class="chart-container"><canvas id="bookingChart"></canvas></div>
        </div>
      </div>

      <!-- Users -->
      <div class="tab-content" id="tab-users">
        <div class="section-bar">
          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
            <h3>User Management</h3>
            <input class="search-input" type="text" placeholder="Search by name or phone..." id="userSearch" oninput="filterUsers()">
          </div>
          <div class="filter-group">
            <button class="filter-btn active" data-filter="all" onclick="setUserFilter('all',this)">All</button>
            <button class="filter-btn" data-filter="customer" onclick="setUserFilter('customer',this)">Customers</button>
            <button class="filter-btn" data-filter="driver" onclick="setUserFilter('driver',this)">Drivers</button>
          </div>
        </div>
        <div id="usersTableWrap"></div>
      </div>

      <!-- Bookings -->
      <div class="tab-content" id="tab-bookings">
        <div class="section-bar">
          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
            <h3>Booking Management</h3>
            <input class="search-input" type="text" placeholder="Search bookings..." id="bookingSearch" oninput="filterBookings()">
          </div>
          <div class="filter-group">
            <button class="filter-btn active" data-bfilter="all" onclick="setBookingFilter('all',this)">All</button>
            <button class="filter-btn" data-bfilter="pending" onclick="setBookingFilter('pending',this)">Pending</button>
            <button class="filter-btn" data-bfilter="accepted" onclick="setBookingFilter('accepted',this)">Accepted</button>
            <button class="filter-btn" data-bfilter="in_progress" onclick="setBookingFilter('in_progress',this)">In Progress</button>
            <button class="filter-btn" data-bfilter="completed" onclick="setBookingFilter('completed',this)">Completed</button>
            <button class="filter-btn" data-bfilter="cancelled" onclick="setBookingFilter('cancelled',this)">Cancelled</button>
          </div>
        </div>
        <div id="bookingsTableWrap"></div>
      </div>

      <!-- Vehicles -->
      <div class="tab-content" id="tab-vehicles">
        <div class="section-bar">
          <h3>Vehicle Pricing</h3>
          <button class="action-btn refresh" onclick="loadVehicles()">Refresh</button>
        </div>
        <div id="vehiclesGrid" class="vehicles-grid"></div>
      </div>

      <!-- Live Drivers -->
      <div class="tab-content" id="tab-drivers">
        <div class="section-bar">
          <h3>Live Drivers <span class="badge badge-green" id="onlineCount">0</span></h3>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:12px;color:var(--text3)" id="driversRefreshTime">Auto-refresh: 10s</span>
            <button class="action-btn refresh" onclick="loadDrivers()">Refresh Now</button>
          </div>
        </div>
        <div id="driversGrid" class="drivers-grid"></div>
      </div>

      <!-- Settings -->
      <div class="tab-content" id="tab-settings">
        <div class="settings-section">
          <div class="settings-card">
            <h3>TransportGo Admin Panel</h3>
            <p>Manage your transport operations from one place.</p>
            <div class="settings-item">
              <span class="si-label">Version</span>
              <span class="si-value">v1.0</span>
            </div>
            <div class="settings-item">
              <span class="si-label">Platform</span>
              <span class="si-value">TransportGo</span>
            </div>
            <div class="settings-item">
              <span class="si-label">Environment</span>
              <span class="si-value">Production</span>
            </div>
            <div class="settings-item">
              <span class="si-label">Admin Phone</span>
              <span class="si-value" id="settingsPhone">-</span>
            </div>
            <div class="settings-item">
              <span class="si-label">Admin Name</span>
              <span class="si-value" id="settingsName">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="bookingModal" onclick="closeModalOutside(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Booking Details</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="bookingModalBody"></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
var API = '';
var token = localStorage.getItem('admin_token');
var currentTab = 'dashboard';
var allUsers = [];
var allBookings = [];
var userFilter = 'all';
var bookingFilter = 'all';
var bookingChart = null;
var driversInterval = null;
var adminUser = null;

function getHeaders() {
  return {'Content-Type':'application/json','Authorization':'Bearer '+token};
}

async function apiCall(url, options) {
  options = options || {};
  options.headers = getHeaders();
  try {
    var res = await fetch(API + url, options);
    if (res.status === 401) { doLogout(); return null; }
    var data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Request failed');
    return data;
  } catch(e) {
    showToast(e.message, 'error');
    return null;
  }
}

function showToast(msg, type) {
  var container = document.getElementById('toastContainer');
  var t = document.createElement('div');
  t.className = 'toast ' + (type || 'success');
  t.innerHTML = (type === 'error' ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>' : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>') + '<span>' + msg + '</span>';
  container.appendChild(t);
  setTimeout(function() { t.classList.add('removing'); setTimeout(function() { t.remove(); }, 300); }, 3000);
}

async function doLogin() {
  var phone = document.getElementById('loginPhone').value.trim();
  var password = document.getElementById('loginPassword').value.trim();
  var errEl = document.getElementById('loginError');
  var btn = document.getElementById('loginBtn');
  if (!phone || !password) { errEl.textContent = 'Please fill in all fields'; errEl.style.display = 'block'; return; }
  btn.disabled = true; btn.textContent = 'Signing in...';
  try {
    var res = await fetch(API + '/api/auth/admin-login', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({phone: phone, password: password})
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Login failed');
    token = data.token;
    adminUser = data.user;
    localStorage.setItem('admin_token', token);
    errEl.style.display = 'none';
    showApp();
  } catch(e) {
    errEl.textContent = e.message; errEl.style.display = 'block';
  }
  btn.disabled = false; btn.textContent = 'Sign In';
}

function doLogout() {
  token = null; adminUser = null;
  localStorage.removeItem('admin_token');
  if (driversInterval) { clearInterval(driversInterval); driversInterval = null; }
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('appWrap').style.display = 'none';
}

function showApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appWrap').style.display = 'flex';
  updateClock();
  setInterval(updateClock, 1000);
  loadAdminInfo();
  switchTab('dashboard');
}

async function loadAdminInfo() {
  if (!adminUser) {
    var data = await apiCall('/api/auth/me');
    if (data) adminUser = data.user;
  }
  if (adminUser) {
    document.getElementById('settingsPhone').textContent = adminUser.phone || '-';
    document.getElementById('settingsName').textContent = adminUser.name || 'Admin';
  }
}

function updateClock() {
  var now = new Date();
  document.getElementById('topbarTime').textContent = now.toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'}) + ' ' + now.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'});
}

var tabTitles = {dashboard:'Dashboard',users:'User Management',bookings:'Booking Management',vehicles:'Vehicle Pricing',drivers:'Live Drivers',settings:'Settings'};

function switchTab(tab) {
  if (driversInterval && currentTab === 'drivers' && tab !== 'drivers') { clearInterval(driversInterval); driversInterval = null; }
  currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(function(el) { el.classList.remove('active'); });
  document.querySelectorAll('.nav-item').forEach(function(el) { el.classList.remove('active'); });
  var tabEl = document.getElementById('tab-' + tab);
  if (tabEl) tabEl.classList.add('active');
  var navEl = document.querySelector('.nav-item[data-tab="' + tab + '"]');
  if (navEl) navEl.classList.add('active');
  document.getElementById('topbarTitle').textContent = tabTitles[tab] || tab;
  if (tab === 'dashboard') loadDashboard();
  else if (tab === 'users') loadUsers();
  else if (tab === 'bookings') loadBookings();
  else if (tab === 'vehicles') loadVehicles();
  else if (tab === 'drivers') { loadDrivers(); driversInterval = setInterval(loadDrivers, 10000); }
}

function showLoading(el) { el.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>'; }
function showEmpty(el, msg) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">&#9744;</div><p>' + (msg || 'No data found') + '</p></div>'; }

async function loadDashboard() {
  var data = await apiCall('/api/admin/stats');
  if (!data) return;
  document.getElementById('statUsers').textContent = (data.totalUsers || 0).toLocaleString();
  document.getElementById('statBookings').textContent = (data.totalBookings || 0).toLocaleString();
  document.getElementById('statActive').textContent = (data.activeBookings || 0).toLocaleString();
  document.getElementById('statRevenue').textContent = 'Rs. ' + (data.totalRevenue || 0).toLocaleString();

  var bData = await apiCall('/api/admin/bookings');
  if (bData && bData.bookings) {
    var recent = bData.bookings.slice(0, 5);
    document.getElementById('recentCount').textContent = bData.bookings.length;
    var wrap = document.getElementById('recentBookingsTable');
    if (recent.length === 0) { showEmpty(wrap, 'No bookings yet'); }
    else {
      var html = '<table class="mini-table"><thead><tr><th>Customer</th><th>Vehicle</th><th>Price</th><th>Status</th></tr></thead><tbody>';
      recent.forEach(function(b) {
        html += '<tr><td>' + esc(b.customerName || 'N/A') + '</td><td>' + esc(b.vehicleType || '') + '</td><td>Rs. ' + (b.totalPrice || 0) + '</td><td>' + statusBadge(b.status) + '</td></tr>';
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }
    renderChart(data, bData.bookings);
  }
}

function renderChart(stats, bookings) {
  var counts = {pending:0,accepted:0,in_progress:0,completed:0,cancelled:0};
  bookings.forEach(function(b) { if (counts.hasOwnProperty(b.status)) counts[b.status]++; });
  var ctx = document.getElementById('bookingChart').getContext('2d');
  if (bookingChart) bookingChart.destroy();
  bookingChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Pending', 'Accepted', 'In Progress', 'Completed', 'Cancelled'],
      datasets: [{
        label: 'Bookings',
        data: [counts.pending, counts.accepted, counts.in_progress, counts.completed, counts.cancelled],
        backgroundColor: ['rgba(245,158,11,0.7)','rgba(59,130,246,0.7)','rgba(139,92,246,0.7)','rgba(34,197,94,0.7)','rgba(239,68,68,0.7)'],
        borderColor: ['#f59e0b','#3b82f6','#8b5cf6','#22c55e','#ef4444'],
        borderWidth: 1, borderRadius: 6, maxBarThickness: 60
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.4)', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.04)' } },
        x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { display: false } }
      }
    }
  });
}

async function loadUsers() {
  var wrap = document.getElementById('usersTableWrap');
  showLoading(wrap);
  var data = await apiCall('/api/admin/users');
  if (!data) return;
  allUsers = data.users || [];
  renderUsers();
}

function setUserFilter(f, el) {
  userFilter = f;
  document.querySelectorAll('#tab-users .filter-btn').forEach(function(b) { b.classList.remove('active'); });
  el.classList.add('active');
  renderUsers();
}

function filterUsers() { renderUsers(); }

function renderUsers() {
  var wrap = document.getElementById('usersTableWrap');
  var search = (document.getElementById('userSearch').value || '').toLowerCase();
  var filtered = allUsers.filter(function(u) {
    if (userFilter !== 'all' && u.role !== userFilter) return false;
    if (search && (u.name || '').toLowerCase().indexOf(search) === -1 && (u.phone || '').indexOf(search) === -1) return false;
    return true;
  });
  if (filtered.length === 0) { showEmpty(wrap, 'No users found'); return; }
  var html = '<table class="data-table"><thead><tr><th>Name</th><th>Phone</th><th>Role</th><th>Vehicle</th><th>Status</th><th>Approved</th><th>Rating</th><th>Trips</th><th>Actions</th></tr></thead><tbody>';
  filtered.forEach(function(u) {
    var roleBadge = u.role === 'driver' ? '<span class="badge badge-blue">Driver</span>' : '<span class="badge badge-teal">Customer</span>';
    var vehicle = u.role === 'driver' ? esc((u.vehicleType || '') + (u.vehicleNumber ? ' ' + u.vehicleNumber : '')) : '-';
    var onlineHtml = '<span class="status-dot ' + (u.isOnline ? 'online' : 'offline') + '"></span> ' + (u.isOnline ? 'Online' : 'Offline');
    var approvedBadge = u.role === 'driver' ? (u.isApproved ? '<span class="badge badge-green">Yes</span>' : '<span class="badge badge-yellow">No</span>') : '<span class="badge badge-gray">N/A</span>';
    var rating = u.rating ? u.rating.toFixed(1) + ' &#9733;' : '-';
    var actions = '';
    if (u.role === 'driver' && !u.isApproved) actions += '<button class="action-btn approve" onclick="approveUser(\'' + u.id + '\')">Approve</button>';
    actions += '<button class="action-btn delete" onclick="deleteUser(\'' + u.id + '\',\'' + esc(u.name) + '\')">Delete</button>';
    html += '<tr><td><strong>' + esc(u.name || 'Unnamed') + '</strong></td><td>' + esc(u.phone) + '</td><td>' + roleBadge + '</td><td>' + vehicle + '</td><td>' + onlineHtml + '</td><td>' + approvedBadge + '</td><td>' + rating + '</td><td>' + (u.totalTrips || 0) + '</td><td>' + actions + '</td></tr>';
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

async function approveUser(id) {
  var data = await apiCall('/api/admin/users/' + id + '/approve', {method:'PUT'});
  if (data) { showToast('User approved successfully'); loadUsers(); }
}

async function deleteUser(id, name) {
  if (!confirm('Are you sure you want to delete user "' + name + '"? This action cannot be undone.')) return;
  var data = await apiCall('/api/admin/users/' + id, {method:'DELETE'});
  if (data) { showToast('User deleted successfully'); loadUsers(); }
}

async function approveAllPending() {
  if (!allUsers.length) {
    var data = await apiCall('/api/admin/users');
    if (data) allUsers = data.users || [];
  }
  var pending = allUsers.filter(function(u) { return u.role === 'driver' && !u.isApproved; });
  if (pending.length === 0) { showToast('No pending drivers to approve', 'error'); return; }
  var count = 0;
  for (var i = 0; i < pending.length; i++) {
    var r = await apiCall('/api/admin/users/' + pending[i].id + '/approve', {method:'PUT'});
    if (r) count++;
  }
  showToast('Approved ' + count + ' driver(s)');
  if (currentTab === 'users') loadUsers();
  if (currentTab === 'dashboard') loadDashboard();
}

async function loadBookings() {
  var wrap = document.getElementById('bookingsTableWrap');
  showLoading(wrap);
  var data = await apiCall('/api/admin/bookings');
  if (!data) return;
  allBookings = data.bookings || [];
  renderBookings();
}

function setBookingFilter(f, el) {
  bookingFilter = f;
  document.querySelectorAll('#tab-bookings .filter-btn').forEach(function(b) { b.classList.remove('active'); });
  el.classList.add('active');
  renderBookings();
}

function filterBookings() { renderBookings(); }

function renderBookings() {
  var wrap = document.getElementById('bookingsTableWrap');
  var search = (document.getElementById('bookingSearch').value || '').toLowerCase();
  var filtered = allBookings.filter(function(b) {
    if (bookingFilter !== 'all' && b.status !== bookingFilter) return false;
    if (search) {
      var haystack = ((b.customerName || '') + ' ' + (b.driverName || '') + ' ' + (b.id || '')).toLowerCase();
      if (haystack.indexOf(search) === -1) return false;
    }
    return true;
  });
  if (filtered.length === 0) { showEmpty(wrap, 'No bookings found'); return; }
  var html = '<table class="data-table"><thead><tr><th>ID</th><th>Customer</th><th>Driver</th><th>Route</th><th>Vehicle</th><th>Dist.</th><th>Price</th><th>Status</th><th>Date</th><th>OTP</th></tr></thead><tbody>';
  filtered.forEach(function(b) {
    var shortId = (b.id || '').slice(-6).toUpperCase();
    var route = esc((b.pickup && b.pickup.area) || 'N/A') + ' &rarr; ' + esc((b.delivery && b.delivery.area) || 'N/A');
    var date = b.createdAt ? new Date(b.createdAt).toLocaleDateString('en-IN', {day:'numeric',month:'short'}) : '-';
    html += '<tr class="clickable" onclick="showBookingDetail(\'' + b.id + '\')">';
    html += '<td><code style="color:var(--primary);font-size:12px">#' + shortId + '</code></td>';
    html += '<td>' + esc(b.customerName || 'N/A') + '</td>';
    html += '<td>' + esc(b.driverName || 'Unassigned') + '</td>';
    html += '<td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + route + '</td>';
    html += '<td>' + esc(b.vehicleType || '') + '</td>';
    html += '<td>' + (b.distance || 0) + ' km</td>';
    html += '<td><strong>Rs. ' + (b.totalPrice || 0) + '</strong></td>';
    html += '<td>' + statusBadge(b.status) + '</td>';
    html += '<td>' + date + '</td>';
    html += '<td><code style="font-size:12px;color:var(--text3)">' + (b.otp || '-') + '</code></td>';
    html += '</tr>';
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

function showBookingDetail(id) {
  var b = allBookings.find(function(x) { return x.id === id; });
  if (!b) return;
  var body = document.getElementById('bookingModalBody');
  var html = '<div class="detail-grid">';
  html += detailItem('Booking ID', b.id);
  html += detailItem('Status', statusBadge(b.status));
  html += detailItem('Customer', esc(b.customerName || 'N/A') + '<br><span style="color:var(--text3);font-size:12px">' + esc(b.customerPhone || '') + '</span>');
  html += detailItem('Driver', esc(b.driverName || 'Unassigned') + (b.driverPhone ? '<br><span style="color:var(--text3);font-size:12px">' + esc(b.driverPhone) + '</span>' : ''));
  html += detailItem('Pickup', esc((b.pickup && b.pickup.area) || 'N/A') + (b.pickup && b.pickup.lat ? '<br><span style="color:var(--text3);font-size:11px">' + b.pickup.lat.toFixed(4) + ', ' + b.pickup.lng.toFixed(4) + '</span>' : ''));
  html += detailItem('Delivery', esc((b.delivery && b.delivery.area) || 'N/A') + (b.delivery && b.delivery.lat ? '<br><span style="color:var(--text3);font-size:11px">' + b.delivery.lat.toFixed(4) + ', ' + b.delivery.lng.toFixed(4) + '</span>' : ''));
  html += detailItem('Vehicle Type', esc(b.vehicleType || '-'));
  html += detailItem('Driver Vehicle', esc(b.driverVehicleNumber || '-'));
  html += detailItem('Distance', (b.distance || 0) + ' km');
  html += detailItem('Est. Time', (b.estimatedTime || 0) + ' min');
  html += detailItem('Base Price', 'Rs. ' + (b.basePrice || 0));
  html += detailItem('Distance Charge', 'Rs. ' + (b.distanceCharge || 0));
  html += detailItem('Total Price', '<strong style="font-size:16px;color:var(--teal)">Rs. ' + (b.totalPrice || 0) + '</strong>');
  html += detailItem('Payment', esc((b.paymentMethod || 'cash').toUpperCase()));
  html += detailItem('OTP', '<code style="font-size:16px;color:var(--yellow);letter-spacing:4px">' + (b.otp || '-') + '</code>');
  if (b.rating) html += detailItem('Rating', b.rating + '/5 &#9733;' + (b.ratingComment ? '<br><span style="color:var(--text3);font-size:12px">' + esc(b.ratingComment) + '</span>' : ''));
  if (b.cancelReason) html += detailItem('Cancel Reason', '<span style="color:#f87171">' + esc(b.cancelReason) + '</span>');
  html += detailItem('Created', formatDateTime(b.createdAt));
  if (b.acceptedAt) html += detailItem('Accepted', formatDateTime(b.acceptedAt));
  if (b.startedAt) html += detailItem('Started', formatDateTime(b.startedAt));
  if (b.completedAt) html += detailItem('Completed', formatDateTime(b.completedAt));
  if (b.cancelledAt) html += detailItem('Cancelled', formatDateTime(b.cancelledAt));
  html += '</div>';
  body.innerHTML = html;
  document.getElementById('bookingModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function detailItem(label, value) { return '<div class="detail-item"><div class="di-label">' + label + '</div><div class="di-value">' + value + '</div></div>'; }

function closeModal() {
  document.getElementById('bookingModal').classList.remove('show');
  document.body.style.overflow = '';
}
function closeModalOutside(e) { if (e.target === document.getElementById('bookingModal')) closeModal(); }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });

async function loadVehicles() {
  var wrap = document.getElementById('vehiclesGrid');
  showLoading(wrap);
  var data = await apiCall('/api/admin/vehicles');
  if (!data || !data.vehicles) return;
  if (data.vehicles.length === 0) { showEmpty(wrap, 'No vehicles configured'); return; }
  var html = '';
  data.vehicles.forEach(function(v) {
    html += '<div class="vehicle-card" id="vc-' + v.id + '">';
    html += '<div class="v-header"><div><h3>' + esc(v.name) + '</h3><div class="v-meta">' + esc(v.type) + '</div></div>';
    html += '<label class="toggle"><input type="checkbox" ' + (v.isActive ? 'checked' : '') + ' onchange="toggleVehicle(\'' + v.id + '\',this.checked)"><span class="slider"></span></label></div>';
    html += '<div class="v-capacity"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16 16,8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>' + esc(v.capacity) + '</div>';
    html += '<div class="v-field"><label>Base Fare (Rs.)</label><input type="number" id="bf-' + v.id + '" value="' + v.baseFare + '" min="0"></div>';
    html += '<div class="v-field"><label>Per Km Charge (Rs.)</label><input type="number" id="pk-' + v.id + '" value="' + v.perKmCharge + '" min="0"></div>';
    html += '<button class="action-btn save" style="width:100%;padding:10px;margin-top:4px" onclick="saveVehicle(\'' + v.id + '\')">Save Changes</button>';
    html += '</div>';
  });
  wrap.innerHTML = html;
}

async function saveVehicle(id) {
  var baseFare = parseFloat(document.getElementById('bf-' + id).value);
  var perKmCharge = parseFloat(document.getElementById('pk-' + id).value);
  var toggle = document.querySelector('#vc-' + id + ' .toggle input');
  var isActive = toggle ? toggle.checked : true;
  var data = await apiCall('/api/admin/vehicles/' + id, {method:'PUT', body: JSON.stringify({baseFare:baseFare, perKmCharge:perKmCharge, isActive:isActive})});
  if (data) showToast('Vehicle updated successfully');
}

function toggleVehicle(id, checked) {}

async function loadDrivers() {
  var wrap = document.getElementById('driversGrid');
  if (!wrap.children.length || wrap.querySelector('.loading')) showLoading(wrap);
  var data = await apiCall('/api/admin/drivers/online');
  if (!data) return;
  var drivers = data.drivers || [];
  document.getElementById('onlineCount').textContent = drivers.length + ' online';
  if (drivers.length === 0) { showEmpty(wrap, 'No drivers currently online'); return; }
  var html = '';
  drivers.forEach(function(d) {
    var initials = (d.name || 'D').charAt(0).toUpperCase();
    var loc = d.location ? d.location.lat.toFixed(4) + ', ' + d.location.lng.toFixed(4) : 'Unknown';
    html += '<div class="driver-card">';
    html += '<div class="driver-avatar">' + initials + '</div>';
    html += '<div class="driver-card-info"><h4>' + esc(d.name || 'Driver') + '</h4>';
    html += '<p>' + esc((d.vehicleType || '') + (d.vehicleNumber ? ' - ' + d.vehicleNumber : '')) + '</p>';
    html += '<p style="font-size:11px;color:var(--text3);margin-top:2px">&#128205; ' + loc + '</p></div>';
    html += '<div class="driver-card-status"><span class="status-dot online"></span>';
    html += '<span>' + (d.rating ? d.rating.toFixed(1) + '&#9733;' : '-') + '</span></div>';
    html += '</div>';
  });
  wrap.innerHTML = html;
}

function statusBadge(status) {
  var map = {pending:'badge-yellow',accepted:'badge-blue',in_progress:'badge-purple',completed:'badge-green',cancelled:'badge-red'};
  var labels = {pending:'Pending',accepted:'Accepted',in_progress:'In Progress',completed:'Completed',cancelled:'Cancelled'};
  return '<span class="badge ' + (map[status] || 'badge-gray') + '">' + (labels[status] || status) + '</span>';
}

function formatDateTime(str) {
  if (!str) return '-';
  var d = new Date(str);
  return d.toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'}) + ' ' + d.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'});
}

function esc(str) {
  if (!str) return '';
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

(function init() {
  if (token) {
    showApp();
  }
  document.getElementById('loginPassword').addEventListener('keydown', function(e) { if (e.key === 'Enter') doLogin(); });
  document.getElementById('loginPhone').addEventListener('keydown', function(e) { if (e.key === 'Enter') doLogin(); });
})();
</script>
</body>
</html>